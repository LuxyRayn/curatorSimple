# zookeeperTestDemo

## To start qsuedo zookeeper cluster:

1. download zookeeper
   
   ```
   zookeeper-3.6.3 https://downloads.apache.org/zookeeper/stable/apache-zookeeper-3.6.3-bin.tar.gz
   ```
   
   
   
2. unzip the zip file and enter the folder, create two folder: /data and /log
   the final folders tree should look like this:
   
   ```
   zookeeper
   |
   |--data--zoo-1
   |     |--zoo-2
   |     |--zoo-3
   |
   |--log --zoo-1
         |--zoo-2
         |--zoo-3
   ```
   
   
   
3. add "myid" file to /data/zoo-* folder
   each myid file contains only one digits that represent the id of the zookeeper server
   
   ![avatar](/readmeimg/img_1.png)
   
   ![avatar](/readmeimg/img_2.png)

```
for exampe: 1 means zkid is 1
data--zoo-1
   |     |--myid
   |--zoo-2
   |     |--myid
   |--zoo-3
         |--myid
```



1. find the config files in this project(/src/main/resources/zkConfig)
   a. change the .cfg files
      the zoo-1.cfg for example:

   ```
   1. set new value of dataDir and dataLogDir, which is the folder you just create in step 2
   
   2. change the clientPort(each node's port has to different from the others in cluster)
   in this project, we set (2181, 2182, 2183)
   
   3. add admin.serverPort at the end of the file, set admin.serverPort value
   likely, we have to set different port for different node
   in this project, we set (8888, 8889, 8890)
   Tips: admin.serverPort is for zk manager(the new feature of recent version)
   
   4. add server.* (* means zkserver id, which you just set in myid file) to the end of the file:
   server.1 = 127.0.0.1:2888:3888
   server.2 = 127.0.0.1:2889:3889
   server.3 = 127.0.0.1:2890:3890
   ```

   b. change the .cmd files
      the zkServer-1.cmd for example:

   ```
   1. set new value for "call", like "call D:/developTool/apache-zookeeper-3.6.3-bin/bin/zkEnv.cmd"
   the address is located at the /bin file of the zookeeper folder
   
   2. set new value for "set ZOOCFG", like "set ZOOCFG=D:\developTool\apache-zookeeper-3.6.3-bin\conf\im_cluster\zoo-3.cfg"
   the file address is the zoo-*.cfg file's address
   ```

2. just start each zkServer-*.cmd in command line

   

3. you can use jps tool to check whether the process is succeed
   if everything ok, you should see the picture below
   ![avatar](/readmeimg/img.png)

   or you can use the offcial tool zkCli.cmd in the zk/bin folder
   ./zkCli.cmd -server 127.0.0.1:2181 

      





## Zookeeper Demo desc

**In the project, we use Curator to operate the zk cluster**

### factory

In factory folder, ClientFactory.java defines two ways to create a CuratorFramework, the simple one and the one with options.

In this project, most of the tests will use the simple one



The ZKclient.java capsulates a zkclient for the user,  you can use the code below to create a new  CuratorFramework:

```java
CuratorFramework client = ZKclient.instance.getClient();
```

you can find out the test of ZKclient in: src/test/java/zookeeperTest/factory/ClientFactoryTest.java



### idmaker

In idmaker folder, we have the SnowflakeIdGenerator.java which is used to generate the uuid (generated by snowflake algo)

The SnowflakeIdGenerator.java shows how to use the algo in zk

you can find out the test of it in <u>src/test/java/zookeeperTest/idmaker/SnowflakeIdGeneratorTest.java</u>



### distributedLock

In distributedLock folder,  the ZKLock.java shows how to realize a distributed reentrant lock in ZK, you can find out the test function in <u>src/main/java/zookeeperTest/distributedlock/ZkLock.java (testLock())</u>

But in reality, we don't recommended to realize our own distributed lock in the production, because curator has already realized the tools for use(InterProcessMutex). You can find out the simple use of InterProcessMutex in In distributedLock folder,  the ZKLock.java shows how to realize a distributed reentrant lock in ZK, you can find out the test function in <u>src/main/java/zookeeperTest/distributedlock/ZkLock.java (testzkMutex())</u>



### concurrent

In concurrent source code folder, you can use the FutureTaskScheduler to launch a concurrency task

the test can be found in <u>src/test/java/zookeeperTest/distributelock/ZkLockTest.java</u>